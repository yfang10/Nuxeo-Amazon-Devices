/*! For license information please see amazon-s3-online-storage.bundle.js.LICENSE.txt */
(self.webpackChunk_nuxeo_nuxeo_web_ui=self.webpackChunk_nuxeo_nuxeo_web_ui||[]).push([[18],{57621:(e,t,r)=>{"use strict";r.r(t);var s=r(9986),o=r(24028),a=r.n(o),i=r(37166),n=r.n(i);let c;s.S.registerProvider("s3",class{constructor(e,t,r){this.connection=e,this.accept=t,this.batchAppend=r,this.uploader=null,this.batchId=null,this.files=[]}_resource(e,t){return c||(c=document.createElement("nuxeo-resource"),c.uncancelable=!0,document.body.appendChild(c)),c.path=e,c.data=t,c}_startKeepAlive(){this._keepAlive=setInterval((()=>{this.files.every((e=>e.complete||e.error))?this._stopKeepAlive():this._resource(["upload",this.batchId].join("/")).get()}),6e4)}_stopKeepAlive(){this._keepAlive&&(clearInterval(this._keepAlive),this._keepAlive=null)}_upload(e,t){return new Promise(((r,s)=>{e.managedUpload=this.uploader.upload({Key:this.extraInfo.baseKey.replace(/^\/+/g,"").concat(n()()),ContentType:e.type,Body:e}),this._startKeepAlive(),e.managedUpload.on("httpUploadProgress",(r=>{"function"==typeof t&&t({type:"uploadProgress",fileIdx:e.index,progress:r.loaded/r.total*100})})).send(((o,a)=>{this._stopKeepAlive(),null===o?(e.managedUpload=null,this._resource(["upload",this.batchId,e.index,"complete"].join("/"),{name:e.name,fileSize:e.size,key:a.Key,bucket:a.Bucket,etag:a.ETag}).post().then((()=>{"function"==typeof t&&t({type:"uploadCompleted",fileIdx:e.index}),r()})).catch((r=>{"function"==typeof t&&t({type:"uploadInterrupted",file:e,error:r.message||r}),s(r)}))):(t({type:"uploadInterrupted",file:e,error:o}),s(o))}))}))}_ensureBatch(){return this.batchAppend&&this.uploader?Promise.resolve():(this.files=[],this._newBatch())}_initCredentials(e){const t=new(a().Credentials)(e.awsSecretKeyId,e.awsSecretAccessKey,e.awsSessionToken);t.expireTime=new Date(e.expiration),t.refresh=e=>this._resource(`upload/${this.batchId}/refreshToken`).post().then((r=>{t.accessKeyId=r.awsSecretKeyId,t.secretAccessKey=r.awsSecretAccessKey,t.sessionToken=r.awsSessionToken,t.expireTime=new Date(r.expiration),e()})),a().config.update({credentials:t,region:e.region,s3ForcePathStyle:e.usePathStyleAccess||!1,useAccelerateEndpoint:e.useS3Accelerate||!1})}_newBatch(){return this._resource("upload/new/s3").post().then((e=>{this.batchId=e.batchId,this.extraInfo=e.extraInfo,this._initCredentials(e.extraInfo),this.uploader=new(a().S3)({params:{Bucket:this.extraInfo.bucket},endpoint:this.extraInfo.endpoint||null,computeChecksums:!0,httpOptions:{timeout:Number(Nuxeo&&Nuxeo.UI&&Nuxeo.UI.config&&Nuxeo.UI.config.s3&&Nuxeo.UI.config.s3.timeout)||0},correctClockSkew:!0})}))}_handleUploadError(e,t){throw this.files.every((e=>e.error))?t({type:"batchFailed",error:e,batchId:this.batchId}):this.files.every((e=>e.error||e.complete))&&t({type:"batchFinished",batchId:this.batchId}),e}get accepts(){return s.S.getProviders().default.prototype.accepts}upload(e,t){this._ensureBatch().then((()=>{t({type:"batchStart",batchId:this.batchId}),(new Date).getTime()>=this.extraInfo.expiration&&this._refreshBatchInfo();const r=[];return Array.from(e).reduce(((e,s)=>(s.index=this.files.length,this.files.push(s),t({type:"uploadStarted",file:s}),e.then((()=>new Promise((e=>{r.push(this._upload(s,(r=>{"uploadProgress"===r.type&&e(s),t(r)})).catch((e=>this._handleUploadError(e,t))))})))))),Promise.resolve()).then((()=>Promise.all(r))).then((()=>t({type:"batchFinished",batchId:this.batchId})))}))}hasAbort(){return!0}hasProgress(){return!0}abort(e){e.managedUpload&&e.managedUpload.abort()}cancelBatch(){this.uploader&&this.files.forEach(this.abort),this.uploader=null,this.batchId=null,this.files=[]}batchExecute(e,t,r){return this.connection.operation(e).then((s=>{const o={url:[s._nuxeo._restURL,"upload",this.batchId,"execute",e].join("/").replace(/\/+/g,"/")};return r&&(o.headers=r),t.context&&(s=s.context(t.context)),s.params(t).execute(o)}))}}),Nuxeo&&Nuxeo.UI&&Nuxeo.UI.config&&Nuxeo.UI.config.s3&&"true"===String(Nuxeo.UI.config.s3.useDirectUpload)&&(a().util.update(a().S3.prototype,{reqRegionForNetworkingError:(e,t)=>t()}),s.S.defaultProvider="s3")},28022:()=>{}}]);