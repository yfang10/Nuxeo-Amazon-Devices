<dom-module id="amzd-keyword-suggestion-import">
    <template>
        <style>
            :host {
                display: block;
            }

            .label {
                @apply --nuxeo-label;
            }
        </style>

        <div hidden="[[!_isAddKeywordAllowed(user, document)]]">
            <label class="label">[[i18n('documentPage.keywords')]]</label>
            <nuxeo-selectivity id="s2" operation="[[operation]]" label="[[label]]" min-chars="[[minChars]]"
                tagging$="[[allowNewKeywords]]" multiple params="[[params]]" placeholder="[[placeholder]]"
                error-message="[[errorMessage]]" value="{{value}}" invalid="[[invalid]]"
                new-entry-formatter="[[newEntryFormatter]]" result-formatter="[[resultFormatter]]"
                added-entry-handler="[[addedKeywordHandler]]" removed-entry-handler="[[removedKeywordHandler]]"
                init-selection="[[initSelection]]" stay-open-on-select="[[stayOpenOnSelect]]">
            </nuxeo-selectivity>
        </div>

        <nuxeo-connection id="nx" user="{{user}}"></nuxeo-connection>

    </template>

    <script>
        Polymer({
            is: 'amzd-keyword-suggestion-import',
            behaviors: [Nuxeo.LayoutBehavior, Nuxeo.I18nBehavior, Nuxeo.IronFormElementBehavior, Nuxeo
                .IronValidatableBehavior
            ],
            properties: {
                /*
                 * Whether or not adding new keyword(s) is allowed.
                 */
                allowNewKeywords: {
                    type: Boolean
                },

                /**
                 * Label.
                 */
                label: String,

                /**
                 * Operation to call for suggestions.
                 */
                operation: {
                    type: String,
                    value: 'Keyword.Suggestion',
                },

                /**
                 * Parameters for the operation.
                 */
                params: Object,

                user: {
                    type: Object
                },
                /**
                 * The document to add / remove keywords from.
                 */
                document: {
                    type: Object,
                    observer: '_observeDocument',
                },

                /**
                 * Selected value(s).
                 */
                value: {
                    type: String,
                    notify: true,
                },

                /**
                 * Minimum number of chars to trigger the suggestions.
                 */
                minChars: {
                    type: Number,
                    value: 1,
                },

                /**
                 * Placeholder.
                 */
                placeholder: {
                    type: String,
                    computed: '_fillPlaceholder(document)'
                },

                /**
                 * If true, the dropdown stays open after a selection is made.
                 */
                stayOpenOnSelect: {
                    type: Boolean,
                    value: false,
                },

                /**
                 * Error message to show when `invalid` is true.
                 */
                errorMessage: String,

                /**
                 * Formatter for suggested entries.
                 */
                resultFormatter: {
                    type: Function,
                    value() {
                        return this._resultFormatter.bind(this);
                    },
                },

                /**
                 * Formatter for initial selection.
                 */
                initSelection: {
                    type: Function,
                    value() {
                        return this._initSelection.bind(this);
                    },
                },

                /**
                 * Formatter for new suggested entries.
                 */
                newEntryFormatter: {
                    type: Function,
                    value() {
                        return this._newEntryFormatter.bind(this);
                    },
                },

                /**
                 * Handler called when a keyword is added.
                 */
                addedKeywordHandler: {
                    type: Function,
                    value() {
                        return this._keywordChangedHandler.bind(this);
                    },
                },

                /**
                 * Handler called when a keyword is removed.
                 */
                removedKeywordHandler: {
                    type: Function,
                    value() {
                        return this._keywordChangedHandler.bind(this);
                    },
                }
            },

            /* Override method from Polymer.IronValidatableBehavior. */
            _getValidity() {
                return this.$.s2._getValidity();
            },

            _fillPlaceholder(doc) {
                if (doc.isProxy) {
                    return ''
                } else {
                    return this.i18n('documentPage.keywords.placeholder')
                }
            },

            _resultFormatter(keyword) {
                return `<span class='s2Keyword'>${this.$.s2.escapeHTML(keyword.displayLabel)}</span>`;
            },

            _newEntryFormatter(term) {
                return {
                    id: term,
                    displayLabel: term,
                    newKeyword: true
                };
            },

            _keywordChangedHandler(entry) {
                if (this.document) {
                    this.document.properties['amzkeyword:keywords'] = this.value.map(v => {
                        return {
                            'label': v,
                            'username': this.user.id
                        }
                    })
                }
            },

            _initSelection(element, callback) {
                return callback(
                    this.value.map((entry) => {
                        return {
                            id: entry,
                            displayLabel: entry
                        };
                    }),
                );
            },

            _observeDocument() {
                if (this.document && this.document.properties['amzkeyword:keywords'] &&
                    this.document.properties['amzkeyword:keywords'].length > 0) {
                    this.value = this.document.properties['amzkeyword:keywords'].map(k => k.label)
                } else {
                    this.value = []
                }
            },

            _isAddKeywordAllowed(user, doc) {
                if (!this.hasFacet(doc, 'AMZKeyword')) {
                    return false
                }

                if (!user) {
                    return false
                }

                if (!user.isAdministrator && user.extendedGroups.map(group => group.name).indexOf(
                        'Keyword_Mgmt') < 0) {
                    return false
                }

                return true
            }
        });
    </script>
</dom-module>