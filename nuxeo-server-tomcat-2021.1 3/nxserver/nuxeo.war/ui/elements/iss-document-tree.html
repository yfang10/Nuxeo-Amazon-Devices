<dom-module id="iss-document-tree">
    <template>
        <style include="iron-flex iron-positioning nuxeo-styles">
            :host {
                display: block;

                --nuxeo-tree-theme: {
                    padding: 1em;
                    color: var(--nuxeo-drawer-text);
                }

                --nuxeo-tree-node-theme: {
                    min-height: 24px;
                }

                --nuxeo-tree-children-theme: {
                    padding-left: 1em;
                }

                --nuxeo-tree-node-more-theme: {
                    line-height: 1.3em;
                    display: inline-block;
                    vertical-align: text-top;
                    margin-left: 1.3em;
                    word-break: break-word;
                }
            }

            .content {
                padding: 5px 0;
                overflow: auto;
                height: calc(100vh - 72px - (var(--nuxeo-app-top, 0) + var(--nuxeo-app-bottom, 0)));
            }

            .node-name {
                line-height: 1.3em;
                display: inline-block;
                vertical-align: text-top;
                margin-left: 1.3em;
                word-break: break-word;
            }

            a {
                @apply --nuxeo-link;
            }

            a:hover {
                @apply --nuxeo-link-hover-color;
            }

            #root a,
            a:active,
            a:visited,
            a:focus {
                color: var(--nuxeo-drawer-text);
            }

            iron-icon {
                opacity: 0.3;
                width: 1.3rem;
                margin-right: -1.6em;
                margin-top: -0.07rem;
            }

            [toggle] {
                cursor: pointer;
            }

            .parents {
                line-height: 1.5em;
            }

            .parents+nuxeo-tree {
                padding: 6px 5px;
            }

            .parents>nuxeo-tree {
                padding: 4px 5px;
            }

            .parents a {
                @apply --layout-horizontal;
                padding: 0.35em;
                color: var(--nuxeo-drawer-text);
                border-bottom: 1px solid var(--nuxeo-border);
            }

            .parents span {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
                display: block;
                min-width: 1.3em;
            }

            .parent {
                padding: 0.12em 0 0;
            }

            paper-spinner {
                height: 1.1rem;
                width: 1.1rem;
                margin-right: -1.4em;
            }

            .noPermission {
                opacity: 0.5;
                font-weight: 300;
                padding: 1.5em 0.7em;
                text-align: center;
                font-size: 1.1rem;
            }

            .header h5 {
                margin: 0;
            }
        </style>

        <nuxeo-document id="doc" doc-path="[[docPath]]" response="{{document}}" enrichers="hasFolderishChild">
        </nuxeo-document>

        <nuxeo-page-provider id="children" provider="tree_children" enrichers="hasContent" schemas="dublincore,common">
        </nuxeo-page-provider>

        <div class="header" hidden$="[[!label]]">
            <h5>[[i18n(label)]]</h5>
        </div>

        <div class="content" role="tree">
            <div class="parents" hidden$="[[_noPermission]]">
                <a href$="[[urlFor('document', '/')]]" class="layout horizontal" hidden$="[[_hideRoot(document)]]">
                    <span aria-hidden="true">
                        <iron-icon icon="icons:chevron-left"></iron-icon>
                    </span>
                    <span class="parent">[[i18n('browse.root')]]</span>
                </a>
                <template is="dom-repeat" items="[[parents]]" as="item">
                    <a href$="[[urlFor(item)]]">
                        <span>
                            <iron-icon icon="icons:chevron-left"></iron-icon>
                        </span>
                        <span class="parent">[[item.title]]</span>
                    </a>
                </template>
            </div>
            <nuxeo-tree id="tree" data="[[document]]" controller="[[controller]]" node-key="uid">
                <template class="horizontal layout">
                    <div role="treeitem" aria-expanded="[[opened]]">
                        <template class="flex" is="dom-if" if="[[!isLeaf]]">
                            <paper-spinner active$="[[loading]]" aria-hidden="true"></paper-spinner>
                            <iron-icon icon="[[_expandIcon(opened)]]" toggle hidden$="[[loading]]" aria-hidden="true">
                            </iron-icon>
                        </template>
                        <span class="node-name flex">
                            <a href$="[[urlFor(item)]]">[[_title(item)]]</a>
                        </span>
                    </div>
                </template>
            </nuxeo-tree>
            <div class="noPermission" hidden$="[[!_noPermission]]">[[i18n('browse.tree.noDocument')]]</div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'iss-document-tree',
            behaviors: [Nuxeo.I18nBehavior,
                Nuxeo.FiltersBehavior,
                Nuxeo.RoutingBehavior
            ],
            properties: {
                controller: Object,
                auto: {
                    type: Boolean,
                    value: false,
                },
                rootDocPath: {
                    type: String,
                    value: '/',
                    observer: '_rootDocPathChanged',
                },
                docPath: {
                    type: String,
                    value: '/',
                },
                document: {
                    type: Object,
                    observer: '_documentChanged',
                },
                currentDocument: {
                    type: Object,
                    observer: '_currentDocumentChanged',
                },
                parents: {
                    type: Array,
                    value: [],
                },
                label: String,
                visible: {
                    type: Boolean,
                },
                cannotSee: {
                    type: Boolean,
                    value: false,
                },
                _noPermission: {
                    type: Boolean,
                    value: false,
                }
            },

            observers: ['_fetchDocument(docPath, visible)'],

            ready() {
                window.addEventListener('nuxeo-documents-deleted', (e) => {
                    if (e.detail.documents) {
                        this.removeDocuments(e.detail.documents);
                        return;
                    }
                    // when in select all mode we don't have a list of documents in the event detail
                    this._fetchDocument();
                });

                window.addEventListener('refresh-display', () => {
                    this._fetchDocument();
                });

                window.addEventListener('document-created', this._fetchDocument.bind(this));

                this.controller = {
                    getChildren: function (node, page) {
                        this.$.children.params = [node.uid];
                        this.$.children.page = page;
                        return this.$.children.fetch().then((data) => {
                            return {
                                items: data.entries,
                                isNextAvailable: this.$.children.isNextPageAvailable,
                            };
                        });
                    }.bind(this),

                    isLeaf(node) {
                        const hasFolderishChild = node.contextParameters && node.contextParameters
                            .hasContent;
                        return !hasFolderishChild;
                    },
                };
            },

            _hideRoot(doc) {
                return this.rootDocPath !== '/' || (doc && doc.type && doc.type === 'Root');
            },

            _fetchDocument() {
                if (this.visible && this.docPath) {
                    this.__fetchDebouncer = Polymer.Debouncer.debounce(this.__fetchDebouncer, Polymer.Async.timeOut.after(150),
                () => {
                        this._noPermission = false;
                        this.$.doc.execute().catch((err) => {
                            if (err && err.status === 403) {
                                this._noPermission = true;
                            } else {
                                throw err;
                            }
                        });
                    });
                }
            },

            _currentDocumentChanged() {
                const doc = this.currentDocument;
                if (doc && doc.path && doc.path.startsWith(this.rootDocPath)) {
                    if (this.docPath === doc.path && this.document && this.document.title !== doc.title) {
                        // If document is the same as before but its name changed, get the document again
                        this.$.doc.get();
                    }

                    if (this.docPath !== doc.path && !this.hasFacet(doc, 'HiddenInNavigation')) {
                        this.$.tree.style.display = 'none';
                        this.parents = [];

                        if (doc.type === 'Root') {
                            this.docPath = doc.path;
                            return;
                        }

                        const {
                            entries
                        } = doc.contextParameters.breadcrumb;
                        this.docPath = entries[entries.length - 1].path;

                        for (let i = 0; i < entries.length - 1; i++) {
                            const entry = entries[i];
                            if (!this.hasFacet(entry, 'HiddenInNavigation') && entry.path.startsWith(this
                                    .rootDocPath)) {
                                this.push('parents', entry);
                            }
                        }
                    }
                }
            },

            _documentChanged() {
                if (this.document && this.hasFacet(this.document, 'Folderish')) {
                    this.$.tree.style.display = 'block';
                }
            },

            _rootDocPathChanged() {
                this.docPath = this.rootDocPath;
            },

            _expandIcon(opened) {
                return `hardware:keyboard-arrow-${opened ? 'down' : 'right'}`;
            },

            _icon(opened) {
                return opened ? 'icons:folder-open' : 'icons:folder';
            },

            _title(item) {
                return item.type === 'Root' ? this.i18n('browse.root') : item.title;
            },

            _loading(loading) {
                return loading ? this.i18n('label.loading') : '';
            },

            removeDocuments(documents) {
                const uids = documents.map((doc) => doc.uid);
                this.$.tree.removeNodes(uids);
            }

        });
    </script>
</dom-module>