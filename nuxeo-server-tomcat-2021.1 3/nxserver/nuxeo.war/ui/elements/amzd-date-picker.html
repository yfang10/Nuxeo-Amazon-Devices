<dom-module id="amzd-date-picker">
    <template>
        <label>[[label]]</label>

        <vaadin-date-picker id="date" name="[[name]]" required$="[[required]]" invalid="[[invalid]]"
            value="{{_inputValue}}" disabled$="[[disabled]]" min="[[min]]" max="[[max]]"
            error-message="[[errorMessage]]">
        </vaadin-date-picker>
    </template>
    <script>
        {
            class DatePicker
                extends Polymer.mixinBehaviors([Nuxeo.I18nBehavior, Nuxeo.IronFormElementBehavior,
                Nuxeo.IronValidatableBehavior], Nuxeo.Element) {

                static get is() {
                    return 'amzd-date-picker';
                }

                static get properties() {
                    return {
                        label: String,

                        /*
                         * The default time of the picked-up date. Format is HH:mm:ss e.g. 12:45:23. Default is 00:00:00 (midnight).
                         */
                        defaultTime: String,

                        errorMessage: String,

                        /*
                         * The maximum date-time input value (e.g. `"2000-01-01"`).
                         */
                        max: String,

                        /*
                         * The minimum date-time input value (e.g. `"2000-01-01"`).
                         */
                        min: String,

                        required: {
                            type: Boolean,
                            value: false,
                        },

                        value: {
                            type: String,
                            notify: true,
                            observer: '_valueChanged',
                        },

                        disabled: {
                            type: Boolean,
                            value: false,
                        },

                        _inputValue: {
                            type: String,
                            observer: '_inputValueChanged',
                        },

                        _preventInputUpdate: {
                            type: Boolean,
                            value: false,
                        },
                    };
                }

                ready() {
                    super.ready();
                    moment.locale((window.nuxeo.I18n.language) ? window.nuxeo.I18n.language.split('-')[0] : 'en');
                    // tell vaadin-date-picker how to display dates since default behavior is US locales (MM-DD-YYYY)
                    // this way we can take advantage of moment locale and use the date format that is most suitable for the user
                    this.$.date.set('i18n.formatDate', (date) => moment(date).format(moment.localeData().longDateFormat('L')));
                    this.$.date.set('i18n.parseDate', (text) => {
                        const date = moment(text, moment.localeData().longDateFormat('L'));
                        return {
                            day: date.format('D'),
                            month: date.format('M') - 1,
                            year: date.format('YYYY'),
                        };
                    });
                    this.$.date.set('i18n.monthNames', moment.months());
                    this.$.date.set('i18n.weekdays', moment.weekdays());
                    this.$.date.set('i18n.weekdaysShort', moment.weekdaysShort());
                    this.$.date.set('i18n.cancel', this.i18n('command.cancel'));
                    this.$.date.set('i18n.clear', this.i18n('command.clear'));
                    this.$.date.set('i18n.today', this.i18n('today'));
                }

                _getValidity() {
                    if (!this.required) {
                        return true;
                    }
                    return !!this.value;
                }

                _valueChanged() {
                    if (!this.value) {
                        this._inputValue = null;
                        return;
                    }
                    const date = moment(this.value);
                    if (this.value && date.isValid()) {
                        this._preventInputUpdate = true;
                        this._inputValue = date.format('YYYY-MM-DD');
                    } else {
                        this._inputValue = '';
                    }
                }

                _inputValueChanged() {
                    if (this._inputValue !== null && !this._preventInputUpdate) {
                        const date = moment(this._inputValue);
                        if (date.isValid()) {
                            if (this.defaultTime) {
                                const time = moment(this.defaultTime, 'HH:mm:ss');
                                if (time.isValid()) {
                                    date.add(time.hour(), 'hour');
                                    date.add(time.minute(), 'minute');
                                    date.add(time.second(), 'second');
                                } else {
                                    throw new Error(`Invalid default time ${this.defaultTime}`);
                                }
                            }
                            this.set('value', date.toJSON());
                        } else {
                            this.set('value', null);
                        }
                    }
                    this._preventInputUpdate = false;
                }

            }

            customElements.define(DatePicker.is, DatePicker);
            Nuxeo.DatePicker = DatePicker;
        }
    </script>
</dom-module>