<!--
`amzd-download-audit-log`
@group Nuxeo UI
@element amzd-download-audit-log
-->
<dom-module id="amzd-download-audit-log">
  <template>
    <style>
      *[role=widget] {
        padding: 5px;
      }
    </style>

    <nuxeo-operation-button
      id="btn"
      operation="AMZD.ExportAuditLog"
      input="[[document]]"
      params="[[_params(document)]]"
      icon="nuxeo:csv-export"
      label="Export Download Report"
      show-label$="[[showLabel]]"
      poll-interval="[[pollInterval]]"
      error-label="csvExportButton.action.error"
      download
    >
    </nuxeo-operation-button>
    
    
  </template>

  <script>
    Polymer({
      is: 'amzd-download-audit-log',
      behaviors: [Nuxeo.NotifyBehavior, Nuxeo.I18nBehavior, Nuxeo.FiltersBehavior],
      properties: {

        /**
         * The interval to poll for the result, in milliseconds.
         */
        pollInterval: {
          type: Number,
          value: 1000,
        },

        /**
         * `true` if the action should display the label, `false` otherwise.
         */
        showLabel: {
          type: Boolean,
          value: false,
        },

        /**
         * Current action status.
         */
        status: {
          type: Object,
          notify: true,
        },
        /**
         * Input document.
         */
        document: Object,
      },

      ready() {
        this.$.btn.addEventListener('poll-start', this._onPollStart.bind(this));
        this.$.btn.addEventListener('response', this._onResponse.bind(this));
      },

      _params(doc) {
        return {
         filename: doc.title +"_download_report.csv",
         providerName: "USER_DOWNLOAD",
         namedQueryParams: {
         eventIds: "downloaded"
        },
        currentPageIndex: 0,
        pageSize: 40,
        queryParams: doc.uid,
        sortBy: "eventDate",
        sortOrder: "desc"
        };
      },

      _onPollStart() {
        this.notify({ message: this.i18n('csvExportButton.action.poll') });
      },

      _onResponse() {
        this.notify({ message: this.i18n('csvExportButton.action.completed') });
      },
    });
  </script>
</dom-module>
